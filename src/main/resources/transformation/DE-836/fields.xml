<?xml version="1.0" encoding="UTF-8"?>
<rules xmlns="http://www.culturegraph.org/metamorph">

  <!-- leads to the redundant entry "id" (doubling the value of RecordIdentifier.identifierForTheRecord).
       TODO: Modify JsonToElasticsearchBulk so that it can read from nested field keys like RecordIdentifier.identifierForTheRecord -->
  <data source="001" name="id"/>

  <!-- 0xx -->
  <entity name="RecordIdentifier" flushWith="001">
    <data name="identifierForTheRecord" source="001" />
  </entity>

  <data name="@language" source="008">
    <substring start="35" end="38" />
    <lookup in="language" />
  </data>

  <entity name="Language" flushWith="@language">
    <data name="languageSource" source="@language" />
    <data name="language" source="@language" />
  </entity>
  <entity name="IdentifierISBN" flushWith="020  .a">
    <data name="identifierISBN" source="020  .a" />
  </entity>

  <!-- 1xx -->
  <entity name="Person" sameEntity="true">
    <combine name="personName" value="${100a}">
      <if>
        <none>
          <data source="1001 .e" />
          <data source="1001 .4" />
        </none>
      </if>
      <data name="100a" source="1001 .a" />
    </combine>
  </entity>

  <!-- 2xx -->
  <entity name="TitleStatement">
    <call-macro name="regex-del-punctuation-end" dsource="245??.a" dname="titleMain" />
  </entity>
  <entity name="TitleAddendum">
    <call-macro name="regex-del-punctuation-end" dsource="245??.b" dname="title" />
  </entity>
  <entity name="Edition">
    <data name="edition" source="250  .a" />
  </entity>

  <entity name="PublicationPlace">
    <call-macro name="regex-del-punctuation-end" dsource="260  .a|2603 .a" dname="printingPlace" />
  </entity>
  <entity name="PublisherName">
    <call-macro name="regex-del-punctuation-end" dsource="260  .b|2603 .b" dname="name" />
  </entity>
  <entity name="DateProper">
    <call-macro name="regex-del-punctuation-end" dsource="260  .c|2603 .c" dname="date" />
  </entity>

  <!-- 300 -->
  <data name="@300a" source="300  .a">
    <regexp match="^(.*?) ?[:;]?$" format="${1}" />
  </data>
  <data name="@300b" source="300  .b">
    <regexp match="^(.*?) ?[:;]?$" format="${1}" />
  </data>

  <combine name="@300b_punct" value=" : ${b1}">
    <if>
      <all>
        <data source="@300b" />
        <data source="@300a" />
      </all>
    </if>
    <data name="b1" source="@300b" />
  </combine>
  <combine name="@300c_punct" value=" ; ${c1}">
    <if>
      <all>
        <data source="300  .c" />
        <data source="300  .a|300  .b" />
      </all>
    </if>
    <data name="c1" source="300  .c" />
  </combine>
  <entity name="Extent">
    <combine name="extent" value="${a}${b}${c}">
      <choose name="a">
        <data source="@300a" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="b">
        <data source="@300b_punct" />
        <data source="@300b" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="c">
        <data source="@300c_punct" />
        <data source="300  .c" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
    </combine>
  </entity>
  <!-- END 300 -->

  <!-- 301-399 -->

  <!-- 4xx -->

  <!-- 5xx -->
  <entity name="Description">
    <data name="description" source="500  .a" />
  </entity>

  <!-- 6xx -->
  <entity name="RSWK" sameEntity="true">
    <combine name="subjectTopicName" value="${a}">
      <if>
        <data source="650??.2">
          <equals string="gnd" />
        </data>
      </if>
      <data name="a" source="650??.a">
        <regexp match="^(.*?).?$" format="${1}" />
      </data>
    </combine>
    <combine name="subjectIdentifier" value="${sf0}">
      <if>
        <data source="650??.2">
          <equals string="gnd" />
        </data>
      </if>
      <data name="sf0" source="650??.0" />
    </combine>
  </entity>

  <!-- 7xx -->
  <entity name="IdentifierISBNParallel" flushWith="776??.z">
    <data name="identifierISBN" source="776??.z" />
  </entity>

  <!-- 8xx -->
  <entity name="SeriesAddedEntryUniformTitle" flushWith="830 0.v">
    <data name="title" source="830 0.a" />
    <data name="volume" source="830 0.v" />
  </entity>
  <entity name="OnlineAccess" flushWith="8304?.u">
    <data name="uri" source="8304?.u" />
  </entity>
</rules>
