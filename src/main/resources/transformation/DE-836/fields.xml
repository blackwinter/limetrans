<?xml version="1.0" encoding="UTF-8"?>
<rules xmlns="http://www.culturegraph.org/metamorph">

  <!-- leads to the redundant entry "id" (doubling the value of RecordIdentifier.identifierForTheRecord).
       TODO: Modify JsonToElasticsearchBulk so that it can read from nested field keys like RecordIdentifier.identifierForTheRecord -->
  <data source="001" name="id" />

  <!-- 0xx -->
  <entity name="RecordIdentifier" flushWith="001">
    <data name="identifierForTheRecord" source="001" />
  </entity>
  <data name="@language_short" source="008">
    <substring start="35" end="38" />
  </data>
  <data name="@language_long" source="@language_short">
    <lookup in="language" />
  </data>
  <entity name="Language" flushWith="record">
    <data name="languageSource" source="@language_short" />
    <data name="language" source="@language_long" />
  </entity>
  <entity name="IdentifierISBN[]" flushWith="record">
    <entity name="" flushWith="020  " sameEntity="true">
      <data name="identifierISBN" source="020  .a" />
    </entity>
  </entity>

  <!-- 1xx -->
  <entity name="Person" flushWith="record">
    <if>
      <none flushWith="record">
        <data source="1001 .e">
          <equals string="editor" />
        </data>
      </none>
    </if>
    <call-macro name="personName"  field="100" />
    <call-macro name="personTitle" field="100" />
    <call-macro name="personBio"   field="100" />
    <call-macro name="personRole"  field="100" />
  </entity>

  <!-- 2xx -->
  <entity name="TitleStatement">
    <call-macro name="regex-del-punctuation-end" dsource="245??.a" dname="titleMain" />
  </entity>
  <entity name="TitleAddendum">
    <call-macro name="regex-del-punctuation-end" dsource="245??.b" dname="title" />
  </entity>
  <entity name="CreatorStatement">
    <data name="creatorStatement" source="245[01]?.c">
      <replace pattern="[.]$" with="" />
    </data>
  </entity>
  <entity name="SeriesAddedEntryUniformTitle[]" flushWith="record">
    <if>
      <none flushWith="record">
        <data source="830??" />
      </none>
    </if>
    <entity name="" flushWith="245??" sameEntity="true">
      <call-macro name="regex-del-punctuation-end" dsource="245??.p" dname="title" />
      <call-macro name="regex-del-punctuation-end" dsource="245??.n" dname="volume" />
    </entity>
  </entity>
  <entity name="Edition">
    <entity name="edition[]" flushWith="record">
      <data name="" source="250  .a">
        <replace pattern="\s?[=/]$" with="" />
      </data>
    </entity>
  </entity>

  <entity name="PublicationPlace">
    <entity name="printingPlace[]" flushWith="record">
      <call-macro name="regex-del-punctuation-end" dsource="260[ 23] .a" dname="" />
    </entity>
  </entity>
  <entity name="PublisherName">
    <entity name="name[]" flushWith="record">
      <call-macro name="regex-del-punctuation-end" dsource="260[ 23] .b" dname="" />
    </entity>
  </entity>
  <entity name="DateProper">
    <entity name="date[]" flushWith="record">
      <call-macro name="regex-del-punctuation-end" dsource="260[ 23] .c" dname="" />
    </entity>
  </entity>

  <!-- 300 -->
  <data name="@300a1" source="300  .a">
    <occurrence only="1" />
    <replace pattern="\s?[:;+\(]?$" with="" />
  </data>
  <data name="@300a2" source="300  .a">
    <occurrence only="2" />
    <replace pattern="\s?[:;+\)]?$" with="" />
  </data>
  <data name="@300b" source="300  .b">
    <replace pattern="\s?[:;+\(]?$" with="" />
  </data>
  <data name="@300c1" source="300  .c">
    <occurrence only="1" />
    <replace pattern="\.?\s?[+\(]?$" with="" />
  </data>
  <data name="@300c2" source="300  .c">
    <occurrence only="2" />
    <replace pattern="\.?\s?[:;+\)]?$" with="" />
  </data>
  <data name="@300e" source="300  .e">
    <replace pattern="\.?\s?\(?$" with="" />
  </data>

  <combine name="@300a2_punct" value="${a2})">
    <if>
      <all>
        <data source="@300a2" />
        <none>
          <data source="@300c2" />
        </none>
      </all>
    </if>
    <data name="a2" source="@300a2" />
  </combine>
  <combine name="@300a2_punct" value="${a2} ; ">
    <if>
      <all>
        <data source="@300a2" />
        <data source="@300c2" />
      </all>
    </if>
    <data name="a2" source="@300a2" />
  </combine>
  <combine name="@300b_punct" value=" : ${b}">
    <if>
      <all>
        <data source="@300b" />
        <data source="@300a1" />
      </all>
    </if>
    <data name="b" source="@300b" />
  </combine>
  <combine name="@300c1_punct" value=" ; ${c1}">
    <if>
      <all>
        <data source="@300c1" />
        <data source="@300a1|@300b" />
      </all>
    </if>
    <data name="c1" source="@300c1" />
  </combine>
  <combine name="@300c2_punct" value="${c2})">
    <data name="c2" source="@300c2" />
  </combine>
  <combine name="@300e_punct" value=" ; ${e}">
    <if>
      <all>
        <data source="300  .e" />
        <data source="@300[ac]1|@300b" />
        <none>
          <data source="@300[ac]2" />
        </none>
      </all>
    </if>
    <data name="e" source="@300e" />
  </combine>
  <combine name="@300e_punct" value=" ; ${e} (">
    <if>
      <all>
        <data source="300  .e" />
        <data source="@300[ac]1|@300b" />
        <data source="@300[ac]2" />
      </all>
    </if>
    <data name="e" source="@300e" />
  </combine>

  <entity name="Extent">
    <combine name="extent" value="${a1}${b}${c1}${e}${a2}${c2}">
      <choose name="a1">
        <data source="@300a1" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="b">
        <data source="@300b_punct" />
        <data source="@300b" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="c1">
        <data source="@300c1_punct" />
        <data source="@300c1" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="e">
        <data source="@300e_punct" />
        <data source="@300e" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="a2">
        <data source="@300a2_punct" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="c2">
        <data source="@300c2_punct" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
    </combine>
  </entity>
  <!-- END 300 -->

  <!-- 301-399 -->

  <!-- 4xx -->
  <entity name="SeriesAddedEntryUniformTitle[]" flushWith="record">
    <if>
      <none flushWith="record">
        <data source="830??" />
		<data source="245??.n" />
		<data source="245??.p" />
      </none>
    </if>
    <entity name="" flushWith="490[01] " sameEntity="true">
      <call-macro name="regex-del-punctuation-end" dsource="490[01] .a" dname="title" />
      <call-macro name="regex-del-punctuation-end" dsource="490[01] .v" dname="volume" />
    </entity>
  </entity>

  <!-- 5xx -->
  <entity name="Description">
    <entity name="description[]" flushWith="record">
      <data name="" source="500  .a" />
    </entity>
  </entity>

  <!-- 6xx -->
  <entity name="RSWK[]" flushWith="record">
    <entity name="" flushWith="650??" sameEntity="true">
      <if>
        <all flushWith="650??" sameEntity="true">
          <data source="650??.2">
            <equals string="gnd" />
          </data>
        </all>
      </if>
      <data name="subjectTopicName" source="650??.a">
        <replace pattern="\.?$" with="" />
      </data>
      <entity name="subjectIdentifier[]" flushWith="650??" sameEntity="true">
        <data name="" source="650??.0" />
      </entity>
      <entity name="identifierGND[]" flushWith="650??" sameEntity="true">
        <data name="" source="650??.0">
          <replace pattern="^\(DE-588\)" with="" />
        </data>
      </entity>
    </entity>
  </entity>

  <!-- 7xx -->
  <entity name="PersonCreator[]" flushWith="record">
    <entity name="" flushWith="7001 " sameEntity="true">
      <if>
        <none flushWith="7001 " sameEntity="true">
          <data source="7001 .4">
            <equals string="edt." />
          </data>
        </none>
      </if>
      <call-macro name="personName"  field="700" />
      <call-macro name="personTitle" field="700" />
      <call-macro name="personBio"   field="700" />
      <call-macro name="personRole"  field="700" />
    </entity>
  </entity>
  <entity name="PersonContributor[]" flushWith="record">
    <entity name="" flushWith="record">
      <if>
        <all flushWith="record">
          <data source="1001 .e">
            <equals string="editor" />
          </data>
        </all>
      </if>
      <call-macro name="personName"  field="100" />
      <call-macro name="personTitle" field="100" />
      <call-macro name="personBio"   field="100" />
      <call-macro name="personRole"  field="100" />
    </entity>
    <entity name="" flushWith="7001 " sameEntity="true">
      <if>
        <all flushWith="7001 " sameEntity="true">
          <data source="7001 .4">
            <equals string="edt." />
          </data>
        </all>
      </if>
      <call-macro name="personName"  field="700" />
      <call-macro name="personTitle" field="700" />
      <call-macro name="personBio"   field="700" />
      <call-macro name="personRole"  field="700" />
    </entity>
  </entity>
  <entity name="IdentifierISBNParallel[]" flushWith="record">
    <entity name="" flushWith="776??" sameEntity="true">
      <entity name="identifierISBN[]" flushWith="776??" sameEntity="true">
        <data name="" source="776??.z" />
      </entity>
    </entity>
  </entity>

  <!-- 8xx -->
  <entity name="SeriesAddedEntryUniformTitle[]" flushWith="record">
    <entity name="" flushWith="830 0" sameEntity="true">
      <call-macro name="regex-del-punctuation-end" dsource="830 0.a" dname="title" />
      <call-macro name="regex-del-punctuation-end" dsource="830 0.v" dname="volume" />
    </entity>
  </entity>
  <entity name="OnlineAccess">
    <entity name="uri[]" flushWith="record">
      <data name="" source="856??.u">
        <unique />
      </data>
    </entity>
  </entity>
</rules>
