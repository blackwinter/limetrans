<?xml version="1.0" encoding="UTF-8"?>
<rules xmlns="http://www.culturegraph.org/metamorph">

  <!-- leads to the redundant entry "id" (doubling the value of RecordIdentifier.identifierForTheRecord).
       TODO: Modify JsonToElasticsearchBulk so that it can read from nested field keys like RecordIdentifier.identifierForTheRecord -->
  <data source="001" name="id" />

  <!-- 0xx -->
  <entity name="RecordIdentifier" flushWith="001">
    <data name="identifierForTheRecord" source="001" />
  </entity>

  <data name="@language" source="008">
    <substring start="35" end="38" />
    <lookup in="language" />
  </data>

  <entity name="Language" flushWith="@language">
    <data name="languageSource" source="@language" />
    <data name="language" source="@language" />
  </entity>
  <entity name="IdentifierISBN">
    <entity name="identifierISBN[]" flushWith="record">
      <data name="" source="020  .a" />
    </entity>
  </entity>

  <!-- 1xx -->
  <entity name="Person" flushWith="record">
    <if>
      <none flushWith="record">
        <data source="1001 .e">
          <equals string="editor" />
        </data>
      </none>
    </if>
    <call-macro name="personName"  field="100" />
    <call-macro name="personTitle" field="100" />
    <call-macro name="personBio"   field="100" />
    <call-macro name="personRole"  field="100" />
  </entity>

  <!-- 2xx -->
  <entity name="TitleStatement">
    <call-macro name="regex-del-punctuation-end" dsource="245??.a" dname="titleMain" />
  </entity>
  <entity name="TitleAddendum">
    <call-macro name="regex-del-punctuation-end" dsource="245??.b" dname="title" />
  </entity>
  <entity name="CreatorStatement">
    <data name="creatorStatement" source="245[01]?.c">
      <replace pattern="[.]$" with="" />
    </data>
  </entity>
  <entity name="Edition">
    <entity name="edition[]" flushWith="record">
	  <data name="" source="250  .a">
	    <regexp match="^(.*?) ?[=/]?$" format="${1}" />
	  </data>
	</entity>
  </entity>

  <entity name="PublicationPlace">
    <entity name="printingPlace[]" flushWith="record">
      <call-macro name="regex-del-punctuation-end" dsource="260  .a|2603 .a" dname="" />
    </entity>
  </entity>
  <entity name="PublisherName">
    <call-macro name="regex-del-punctuation-end" dsource="260  .b|2603 .b" dname="name" />
  </entity>
  <entity name="DateProper">
    <call-macro name="regex-del-punctuation-end" dsource="260  .c|2603 .c" dname="date" />
  </entity>

  <!-- 300 -->
  <data name="@300a" source="300  .a">
    <regexp match="^(.*?) ?[:;+]?$" format="${1}" />
  </data>
  <data name="@300b" source="300  .b">
    <regexp match="^(.*?) ?[:;+]?$" format="${1}" />
  </data>
  <data name="@300c" source="300  .c">
    <regexp match="^(.*?) ?[+]?$" format="${1}" />
  </data>

  <combine name="@300b_punct" value=" : ${b1}">
    <if>
      <all>
        <data source="@300b" />
        <data source="@300a" />
      </all>
    </if>
    <data name="b1" source="@300b" />
  </combine>
  <combine name="@300c_punct" value=" ; ${c1}">
    <if>
      <all>
        <data source="@300c" />
        <data source="300  .a|300  .b" />
      </all>
    </if>
    <data name="c1" source="@300c" />
  </combine>
  <combine name="@300e_punct" value=" + ${e1}">
    <if>
      <all>
        <data source="300  .e" />
        <data source="300  .a|300  .b|300  .c" />
      </all>
    </if>
    <data name="e1" source="300  .e" />
  </combine>
  <entity name="Extent">
    <combine name="extent" value="${a}${b}${c}${e}">
      <choose name="a">
        <data source="@300a" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="b">
        <data source="@300b_punct" />
        <data source="@300b" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="c">
        <data source="@300c_punct" />
        <data source="@300c" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
      <choose name="e">
        <data source="@300e_punct" />
        <data source="300  .e" />
        <data source="300*">
          <constant value="" />
        </data>
      </choose>
    </combine>
  </entity>
  <!-- END 300 -->

  <!-- 301-399 -->

  <!-- 4xx -->

  <!-- 5xx -->
  <entity name="Description">
    <entity name="description[]" flushWith="record">
      <data name="" source="500  .a" />
    </entity>
  </entity>

  <!-- 6xx -->
  <entity name="RSWK" sameEntity="true">
    <combine name="subjectTopicName" value="${a}">
      <if>
        <data source="650??.2">
          <equals string="gnd" />
        </data>
      </if>
      <data name="a" source="650??.a">
        <regexp match="^(.*?).?$" format="${1}" />
      </data>
    </combine>
    <combine name="subjectIdentifier" value="${sf0}">
      <if>
        <data source="650??.2">
          <equals string="gnd" />
        </data>
      </if>
      <data name="sf0" source="650??.0" />
    </combine>
  </entity>

  <!-- 7xx -->
  <entity name="PersonCreator[]" flushWith="record">
    <entity name="" flushWith="7001 " sameEntity="true">
      <if>
        <none flushWith="7001 " sameEntity="true">
          <data source="7001 .4">
            <equals string="edt." />
          </data>
        </none>
      </if>
      <call-macro name="personName"  field="700" />
      <call-macro name="personTitle" field="700" />
      <call-macro name="personBio"   field="700" />
      <call-macro name="personRole"  field="700" />
    </entity>
  </entity>
  <entity name="PersonContributor[]" flushWith="record">
    <entity name="" flushWith="record">
      <if>
        <all flushWith="record">
          <data source="1001 .e">
            <equals string="editor" />
          </data>
        </all>
      </if>
      <call-macro name="personName"  field="100" />
      <call-macro name="personTitle" field="100" />
      <call-macro name="personBio"   field="100" />
      <call-macro name="personRole"  field="100" />
    </entity>
    <entity name="" flushWith="7001 " sameEntity="true">
      <if>
        <all flushWith="7001 " sameEntity="true">
          <data source="7001 .4">
            <equals string="edt." />
          </data>
        </all>
      </if>
      <call-macro name="personName"  field="700" />
      <call-macro name="personTitle" field="700" />
      <call-macro name="personBio"   field="700" />
      <call-macro name="personRole"  field="700" />
    </entity>
  </entity>
  <entity name="IdentifierISBNParallel">
    <entity name="identifierISBN[]" flushWith="record">
      <data name="" source="776??.z" />
    </entity>
  </entity>

  <!-- 8xx -->
  <entity name="SeriesAddedEntryUniformTitle" flushWith="830 0.v">
    <call-macro name="regex-del-punctuation-end" dsource="830 0.a" dname="title" />
    <call-macro name="regex-del-punctuation-end" dsource="830 0.v" dname="volume" />
  </entity>
  <entity name="OnlineAccess">
    <entity name="uri[]" flushWith="record">
      <data name="" source="856??.u">
        <unique />
      </data>
    </entity>
  </entity>
</rules>
