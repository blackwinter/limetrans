<?xml version="1.0" encoding="UTF-8"?>
<metamorph xmlns="http://www.culturegraph.org/metamorph" xmlns:xi="http://www.w3.org/2001/XInclude" version="1">
  <xi:include href="macros/alma.xml"/>
  <xi:include href="maps/alma-branches.xml"/>
  <xi:include href="maps/alma-taxonomy.xml"/>

  <rules xmlns="http://www.culturegraph.org/metamorph">
    <data name="id" source="035  .a">
      <regexp match="^\($[catalogid]\)([BCHT].*)" format="${1}" />
      <occurrence only="1" />
    </data>

    <entity name="IdentifierAlma" flushWith="record">
      <data name="identifierMMS" source="001" />
      <call-macro name="alma-member-filter" dname="identifierMMSIZ" entity="MBD  " source="i" />
    </entity>

    <!-- Alma-HOL (MAB 200$#9$2 = NAME DER 1. KÖRPERSCHAFT) (Zeitschriften-Bestandsangabe) -->
    <entity name="HoldingsStatement[]" flushWith="record">
      <entity name="" flushWith="H66??" sameEntity="true">
        <call-macro name="alma-mms-filter" dname="note" entity="H66??" source="z" filter="8" />
      </entity>
    </entity>

    <!-- Alma-HOL (MAB 655$$2 = ELEKTRONISCHE ADRESSE UND ZUGRIFFSART) (Bibliotheksspezifische URL) -->
    <entity name="OnlineAccess[]" flushWith="record">
      <entity name="" flushWith="856??" sameEntity="true">
        <if>
          <all flushWith="856??" sameEntity="true">
            <data source="856??.M">
              <equals string="$[member]" />
            </data>
          </all>
        </if>
        <data name="uri" source="856??.u" />
        <data name="nonpublicnote" source="856??.x" />
        <data name="publicnote" source="856??.z" />
        <data name="relatedto" source="856??.3" />
      </entity>
    </entity>

    <!-- Alma-BIB (MAB 710$a$a = SCHLAGWÖRTER UND SCHLAGWORTKETTEN) (Sachschlagwort) / SISIS Feld 710 (Schlagwörter) -->
    <call-macro name="alma-member-filter" dname="@SubjectHeadings" entity="982  " source="b" />
    <entity name="SubjectHeadings.subject[]" flushWith="record">
      <data name="" source="@SubjectHeadings">
        <unique />
      </data>
    </entity>

    <!-- Alma-BIB (MAB 700$h9$2 = NOTATION EINES KLASSIFIKATIONSSYSTEMS) (Lokale Klassifikation / Sachgruppen) / SISIS Feld 700 (Notationen) -->
    <call-macro name="alma-member-filter" dname="@SubjectGHBLocal" entity="983  " source="b" />
    <combine name="@SubjectGHBLocal" value="${value}" sameEntity="true">
      <if>
        <data source="084  .2">
          <equals string="ghbs" />
        </data>
      </if>
      <data name="value" source="084  .a" />
    </combine>
    <entity name="SubjectGHBLocal.subject[]" flushWith="record">
      <data name="" source="@SubjectGHBLocal">
        <unique />
      </data>
    </entity>

    <entity name="introx.taxonomy[]" flushWith="record">
      <data name="" source="@SubjectGHBLocal">
        <lookup in="alma-notation-to-taxonomy" />
        <unique />
      </data>
    </entity>

    <!-- Alma-HOL (MAB 027$$a = LOKALE IDENTIFIKATIONSNUMMER) / SISIS Feld 600 (Kommentar extern) -->
    <call-macro name="alma-member-filter" dname="@description" entity="989  " source="a" />
    <entity name="Description.description[]" flushWith="record">
      <data name="" source="@description">
        <regexp match="$[regexp.description]" />
        <unique />
      </data>
      <call-macro name="alma-mms-filter" dname="" entity="H52??" source="z" filter="8" />
    </entity>

    <!-- Call number subfield (MAB 088$$a = Angabe der redigierenden Bibliothek) / SISIS Feld 9902 (Buchdatensignatur) -->
    <call-macro name="alma-member-filter" dname="@callnumber" entity="ITM  " source="[cz]" />
    <call-macro name="alma-mms-filter" dname="@callnumber" entity="H52??" source="h" filter="8" />
    <entity name="Item.callnumber[]" flushWith="record">
      <data name="" source="@callnumber">
        <not-equals string="" />
        <unique />
      </data>
    </entity>

    <call-macro name="alma-member-filter" dname="@current_library" entity="ITM  " source="w" />
    <call-macro name="alma-member-filter" dname="@current_location" entity="ITM  " source="x" />
    <entity name="introx.branch[]" flushWith="record">
      <data name="" source="@current_library">
        <lookup in="alma-library-to-branch-$[isil]" />
        <unique />
      </data>
      <data name="" source="@current_location">
        <lookup in="alma-location-to-branch-$[isil]" />
        <unique />
      </data>
    </entity>
  </rules>
</metamorph>
